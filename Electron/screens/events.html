<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Eventos - FallApp</title>
  <link rel="stylesheet" href="../css/login.css">
  <link rel="stylesheet" href="../css/events.css">
</head>
<body class="login-page events-page">
  <div class="login-container">
    <div class="events-center">
      <div class="events-header">
        <div>
          <h1 class="events-title">Eventos</h1>
          <div class="muted">Gestiona los eventos: crea, edita, elimina y visualiza detalles.</div>
        </div>
        <div class="header-actions">
          <button id="events-back" class="btn-back" type="button"><svg viewBox="0 0 24 24" aria-hidden="true"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>Volver</button>
          <button id="btn-new" class="btn-primary">Nuevo evento</button>
        </div>
      </div>

    <div class="search-wrapper">
      <input id="search" placeholder="Buscar por nombre, lugar o creador">
    </div>

    <div id="events" class="events-list" aria-live="polite">
      <!-- Eventos renderizados aquí -->
    </div>
    <div id="empty" class="muted">No hay eventos.</div>
  </div>

  <!-- Modal formulario -->
  <div id="modal" class="modal" role="dialog" aria-modal="true">
    <div class="modal-card" role="document">
      <div class="modal-header">
        <h3 id="modal-title">Nuevo evento</h3>
        <button id="modal-close" class="modal-close" aria-label="Cerrar">×</button>
      </div>
      <form id="event-form">
        <input type="hidden" id="event-id">
        <div class="form-row">
              <label>
                Nombre
                <input id="name" required>
              </label>
              <label>
                Creador
            <input id="creator" placeholder="Usuario que crea el evento" required readonly class="readonly-creator">
              </label>
        </div>

        <div class="form-row">
          <label>
            Fecha
            <input id="date" type="date" required>
          </label>
          <label>
            Hora
            <input id="time" type="time" required>
          </label>
        </div>

        <div class="field">
          <label>
            Lugar
            <input id="place" required>
          </label>
        </div>

        <div class="field">
          <label>
            Descripción
            <textarea id="description" rows="4"></textarea>
          </label>
        </div>

        <div class="form-actions">
          <button type="button" id="btn-cancel" class="btn-secondary">Cancelar</button>
          <button type="submit" id="btn-save" class="btn-primary">Guardar</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    // Interfaz lista: maneja eventos localmente. Reemplaza los api* por llamadas reales al backend.
    const STORAGE_KEY = 'fallapp_events_v1';

    let events = loadEvents();
    const eventsEl = document.getElementById('events');
    const emptyEl = document.getElementById('empty');

    function loadEvents(){
      try{ const s = localStorage.getItem(STORAGE_KEY); return s? JSON.parse(s): [] }catch(e){return[]}
    }

    function saveLocal(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(events)); }

    function renderList(filter=''){
      eventsEl.innerHTML = '';
      const filtered = events.filter(ev => {
        const q = filter.trim().toLowerCase();
        if(!q) return true;
        return (ev.name||'').toLowerCase().includes(q) || (ev.place||'').toLowerCase().includes(q) || (ev.creator||'').toLowerCase().includes(q);
      });

      if(filtered.length===0){ emptyEl.style.display='block'; return } else { emptyEl.style.display='none' }

      filtered.sort((a,b)=> new Date(a.date + ' ' + (a.time||'00:00')) - new Date(b.date + ' ' + (b.time||'00:00')));

      for(const ev of filtered){
        const card = document.createElement('div'); card.className='event-card';
        const left = document.createElement('div');
        const title = document.createElement('strong'); title.textContent = ev.name || '(sin nombre)';
        const meta = document.createElement('div'); meta.className='event-meta';
        meta.innerHTML = `<span class="meta-chip"><strong>Creador:</strong> ${escapeHtml(ev.creator||'')}</span><span class="meta-chip"><strong>Fecha:</strong> ${ev.date||''} ${ev.time||''}</span><span class="meta-chip"><strong>Lugar:</strong> ${escapeHtml(ev.place||'')}</span>`;
        const desc = document.createElement('div'); desc.className='desc'; desc.textContent = ev.description || '';

        left.appendChild(title);
        left.appendChild(meta);
        left.appendChild(desc);

        const actions = document.createElement('div'); actions.className='event-actions';
        const btnView = document.createElement('button'); btnView.className='btn'; btnView.textContent='Ver'; btnView.addEventListener('click', ()=>openView(ev.id));
        const btnEdit = document.createElement('button'); btnEdit.className='btn'; btnEdit.textContent='Editar'; btnEdit.addEventListener('click', ()=>openEdit(ev.id));
        const btnDel = document.createElement('button'); btnDel.className='btn btn-danger'; btnDel.textContent='Eliminar'; btnDel.addEventListener('click', ()=>deleteEvent(ev.id));

        actions.appendChild(btnView); actions.appendChild(btnEdit); actions.appendChild(btnDel);

        card.appendChild(left); card.appendChild(actions);
        eventsEl.appendChild(card);
      }
    }

    function escapeHtml(s){ return String(s||'').replace(/[&<>\"]/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }

    // Modal & form logic
    const modal = document.getElementById('modal');
    const form = document.getElementById('event-form');
    const inputs = {id:document.getElementById('event-id'),name:document.getElementById('name'),creator:document.getElementById('creator'),date:document.getElementById('date'),time:document.getElementById('time'),place:document.getElementById('place'),description:document.getElementById('description')}

    document.getElementById('btn-new').addEventListener('click', openNew);
    document.getElementById('btn-cancel')?.addEventListener('click', closeModal);
    document.getElementById('modal-close')?.addEventListener('click', closeModal);
    // Cerrar modal al clicar fuera del contenido
    document.getElementById('modal').addEventListener('click', (ev)=>{ if(ev.target.id==='modal') closeModal(); });
    document.getElementById('search').addEventListener('input', e=>renderList(e.target.value));
    // Sidebar actions removed; import/export handled by backend when integrated

    function openNew(){
      openModal();
      document.getElementById('modal-title').textContent='Nuevo evento';
      form.reset(); inputs.id.value='';
      const current = localStorage.getItem('fallapp_user') || '';
      inputs.creator.value = current;
    }

    function openEdit(id){
      const ev = events.find(x=>x.id===id); if(!ev) return alert('Evento no encontrado');
      openModal(); document.getElementById('modal-title').textContent='Editar evento';
      inputs.id.value = ev.id; inputs.name.value=ev.name||''; inputs.date.value=ev.date||''; inputs.time.value=ev.time||''; inputs.place.value=ev.place||''; inputs.description.value=ev.description||'';
      // Mostrar el creador pero no permitir editarlo
      inputs.creator.value = ev.creator || localStorage.getItem('fallapp_user') || '';
    }

    function openView(id){
      const ev = events.find(x=>x.id===id); if(!ev) return alert('Evento no encontrado');
      const text = `Nombre: ${ev.name}\nCreador: ${ev.creator}\nFecha: ${ev.date} ${ev.time||''}\nLugar: ${ev.place}\n\nDescripción:\n${ev.description||''}`;
      alert(text);
    }

    function openModal(){ modal.style.display='flex'; }
    function closeModal(){ modal.style.display='none'; }

    form.addEventListener('submit', (e)=>{ e.preventDefault(); saveFromForm(); });

    function saveFromForm(){
      const id = inputs.id.value;
      // El creador será el usuario logueado; si no hay, usar el valor del input (fallback)
      const currentUser = localStorage.getItem('fallapp_user') || inputs.creator.value.trim();
      const payload = { id: id || generateId(), name: inputs.name.value.trim(), creator: currentUser, date: inputs.date.value, time: inputs.time.value, place: inputs.place.value.trim(), description: inputs.description.value.trim() };

      if(id){
        // Mantener el creador original al editar (no se permite cambiar)
        const idx = events.findIndex(x=>x.id===id);
        if(idx>=0){
          const original = events[idx];
          payload.creator = original.creator || payload.creator;
          events[idx]=payload;
        }
        saveLocal(); renderList(document.getElementById('search').value);
      } else {
        // Crear nuevo evento con el usuario actual como creador
        events.push(payload); saveLocal(); renderList(document.getElementById('search').value);
      }

      closeModal();
    }

    function deleteEvent(id){
      if(!confirm('¿Eliminar este evento?')) return;
      // Aquí irá la llamada a la API para eliminar: await apiDeleteEvent(id)
      events = events.filter(x=>x.id!==id); saveLocal(); renderList(document.getElementById('search').value);
    }

    function generateId(){ return 'ev_' + Math.random().toString(36).slice(2,9); }

    // STUB: funciones para integrar la API. Reemplazar por implementaciones reales.
    async function apiFetchEvents(){ /* return await fetch('/api/events')... */ }
    async function apiCreateEvent(payload){ /* return await fetch('/api/events', {method:'POST',body:JSON.stringify(payload)}) */ }
    async function apiUpdateEvent(payload){ /* return await fetch('/api/events/'+payload.id, {method:'PUT',body:JSON.stringify(payload)}) */ }
    async function apiDeleteEvent(id){ /* return await fetch('/api/events/'+id, {method:'DELETE'}) */ }

    // Render inicial
    renderList();

    // Back button: volver a la página anterior si existe historial
    const backBtn = document.getElementById('events-back');
    if(backBtn){ backBtn.addEventListener('click', ()=>{ if(window.history.length>1) window.history.back(); else window.location.href='home.html'; }); }
  </script>
</body>
</html>
